#include "stdlib.h"
#include "dealer.h"
#include "deck.h"
#include "errors.h"
#include "game.h"

Dealer* init_dealer(int playerCount, char* deckString, 
        char* pathString) {
    Dealer* dealer = (Dealer*) malloc(sizeof(Dealer));
    dealer->game = init_game(DEALER_ID, playerCount, pathString);
    if (dealer->game == NULL) {
        exit(dealer_error_msg(BAD_PATH));
    }
    dealer->deck = read_deck(deckString);
    if (dealer->deck == NULL) {
        exit(dealer_error_msg(BAD_DECK));
    }
    dealer->nextCard = 0;
    dealer->comStreams = (FILE***) malloc(sizeof(FILE**) * playerCount);
    for (int i = 0; i < playerCount; i++) {
        dealer->comStreams[i] = (FILE**) malloc(sizeof(FILE**) * STREAM_COUNT);
    }
    return dealer;
}

void close_com_streams(int playerCount, FILE*** comStreams) {
    for (int i = 0; i < playerCount; i++) {
        for (int j = 0; j < STREAM_COUNT; j++) {
            fclose(comStreams[i][j]);
        }
        free(comStreams[i]);
    }
    free(comStreams);
}

void free_dealer(Dealer* dealer) {
    close_com_streams(dealer->game->playerCount, dealer->comStreams);
    free_deck(dealer->deck);
    free_game(dealer->game);
    free(dealer);
}

void next_card(Dealer* dealer) {
    dealer->nextCard++;
    if (dealer->nextCard == dealer->deck->cardCount) {
        dealer->nextCard = 0;
    }
}