#include "player.h"
#include "path.h"
#include "deck.h"
#include "errors.h"
#include "utility.h"
#include "stdlib.h"
#include "stdbool.h"
#include "stdio.h"
#include "string.h"

/**
 * Initialises the player.
 * Param:
 * pid - the player ID of the player.
 * Returns the initialised player.
 */
Player* init_player(int pid) {
    Player* player = (Player*) malloc(sizeof(Player));
    player->pid = pid;
    player->money = STARTING_MONEY;
    player->V1 = 0;
    player->V2 = 0;
    player->points = 0;
    player->currentSite = 0;
    player->lastTurn = 0;
    player->deck = create_deck(0, NULL);
    return player;
}

/**
 * Frees the players.
 * Param:
 * players - the players to be freed.
 * playerCount - the number of players.
 */
void free_players(Player** players, int playerCount) {
    for (int i = 0; i < playerCount; i++) {
        free_deck(players[i]->deck);
        free(players[i]);
    }
    free(players);
}

/**
 * Updates the player based on the updateInfo.
 * Param:
 * path - contains the path info.
 * player - the player to be updated.
 * updateInfo - contains the info to update the player.
 */
void update_player(Path* path, Player* player, int* updateInfo, 
        int currentTurn) {
    player->currentSite = updateInfo[NEW_SITE_INDEX];
    player->lastTurn = currentTurn;
    if (path->sites[updateInfo[NEW_SITE_INDEX]] == V1) {
        player->V1++;
    }
    if (path->sites[updateInfo[NEW_SITE_INDEX]] == V2) {
        player->V2++;
    }
    player->points += updateInfo[POINTS_INDEX];
    player->money += updateInfo[MONEY_INDEX];
    if (updateInfo[CARD_INDEX] != 0) {
        add_card(player->deck, updateInfo[CARD_INDEX]);
    } 
}

/**
 * Calculates the player's score.
 * Param:
 * player - the player to calculate the score of.
 * Returns the player's score.
 */
int calculate_player_score(Player* player) {
    return calculate_deck_score(player->deck) + player->points + player->V1 + 
            player->V2;
}

